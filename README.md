# Smart Contracts for Mastermine

## Prepare environment

1. Create a .env file and where o save the private key of your wallet.
   The .env file should look like this:

```
#Account 1 keys => deployer account
PUBLIC_KEY=<PRIV KEY>
PRIVATE_KEY=<PUB KEY>

#Account 2 keys => to transfer the datatokens
PRIVATE_KEY_ACCOUNT2=<PRIV KEY>
PUBLIC_KEY_ACCOUNT2=<PUB KEY>

ADDRESS_FILE=./addresses/contractAddresses.json
NETWORK_URL= <RPC URL>
SC_DIR=<FOLDER PATH>
```

2. In the hardhat.config.js specify the various networks to play around with different wallets

```js
    'iota-evm-testnet': {
      url: 'https://json-rpc.evm.testnet.iotaledger.net',
      chainId: 1075,
      gas: 2100000, 
      gasPrice: 1000000000000,
      accounts: [process.env.PRIVATE_KEY],
    }
```

## Requirements

1. [Solidity compiler (hardhat)](https://hardhat.org/)
2. [npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm)

Clone the repository and install the dependecies.

```sh
$ npm install --save-dev
```

Compile the contracts

```sh
$ npx hardhat compile
```

## Local Deployment

Smart contracts can be deployed on the hardhat local network. It is an EVM-like emulated chain.

1. Start a local node

```sh
$ npm install
$ npx hardhat node
```

2. In other shell we can run the deploy script by specifying the local hardhat network

```sh
$ npx hardhat run --network localhost scripts/deploy.js
```

3. To fund your addresses

```sh
$ npx hardhat --network localhost faucet <eth-address>
```

## Deploy the contracts and interacts with them

1. Deploy the contracts

```sh
$ npx hardhat run --network iota-evm-testnet scripts/deploy.js
```

2. Create a random passport

```sh
$ python3 ./scripts/create_passport.py
```

3. Deploy the NFT and datatokens

```sh
$ node ./scripts/deploy_nft.js
```

4. Transfer the datatokens to account2's address

```sh
$ node ./scripts/transfer_token.js
```

5. Accumulate part of the datatokens to factory address

```sh
$ node ./scripts/accumulate_token.js
```

5. Burn all accumulated datatokens to mint a new NFT

```sh
$ node ./scripts/burn_to_mint_nft.js
```

## Run a webpage to mint a RMP (NFT + Data Token)

### Requirements

[MetaMask](https://MetaMask.io/download) installed and configured in your browser.

### MetaMask Configuration

- Download MetaMask from [here](https://MetaMask.io/download)
- Agree to the terms of use then click 'Create a new Wallet'
- Click 'Create a new wallet'
- Decide to agree or not to help improve MetaMask
- Create a password
- Click on 'Secure my wallet', to get the Secret Recovery Phrase (12 words), and save those words in a secure place. Be
  careful, these words are the key to access to your account do not share them
- Confirm the Secret Recovery Phrase inserting the missing words in the form

### Add a new Network to MetaMask

- Open the wallet
- Click on Ethereum Mainnet in the upper left corner
- Click add a custom network in bottom
- Complete in this way:

```
Network name: IOTA EVM Testnet
Default RPC URL: https://json-rpc.evm.testnet.iotaledger.net
Chain ID: 1075
Currency symbol: IOTA
Block explorer: https://explorer.evm.testnet.iotaledger.net/
```

- Save, click again on Ethereum Mainnet in the upper left corner and select IOTA EVM Testnet

In this way all the transactions will be signed in the selected network

### Usage

To deploy a webpage that allows to mint a RMP run these commands:

```shell
cd frontend_miner
npm install 
npm run dev
```

The terminal will tell the address of the webpage.
In that page is possible to insert the RMP data, the mint button in the bottom.
At that point MetaMask will ask for your password (just the first time) and then will ask to confirm the transaction.
A confirmation pop up will appear, download the file to not lose the NFT and the DT addresses.
The NFT will be automatically added in MetaMask while you should need to add the DT,
go to the token tab in MetaMask click the three dots a select 'Import Tokens' paste there the address shown in the
confirmation pop up.

## Verify the deployed smart contracts code

Verifying a contract means making its source code public, along with the compiler settings you used, which
allows anyone to compile it and compare the generated bytecode with the one that is deployed on-chain.

1. Modify the hardhat config by adding the `etherscan` information as follows:

```js
    module.exports = {
        solidity: "0.8.18",
        settings: {
            ...
        },
        networks: {
            ...
        },
        etherscan: {
            apiKey: {
            'iota-evm-testnet': 'ABCDE12345ABCDE12345ABCDE123456789' 
            },
            customChains: [
            {
                network: 'iota-evm-testnet',
                chainId: 1071,
                urls: {
                apiURL: 'https://explorer.evm.testnet.iotaledger.net//api',
                browserURL: 'https://explorer.evm.testnet.iotaledger.net//'
                }
            }
            ]
        }
    };
```

2. Verify the SCs' code:

```sh
$ npx hardhat verify --network iota-evm-testnet <contract address> "<contract constructor Arg1>" "<contract constructor Arg2>"
```
